<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thời Trang</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rethink+Sans:ital,wght@0,400..800;1,400..800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="logo">
            <img src="logo.png" alt="Logo Shop" />
            <h1>Shop Thời Trang LT</h1>
        </div>
        <p>123 Đường Linh Trung, Thủ Đức TP.HCM | 0909 123 456</p>
    </header>

    <main>
        <div class="product-list" id="productList">
        </div>
    </main>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeOrderFormModal()">&times;</span>
            <h2>Thông tin đơn hàng</h2>
            <div class="detail">
                <div>
                    <div class="image-container">
                        <img id="image" src="" alt="">
                    </div>
                    <h2 id="productTitle"></h2>
                    <p id="productDescription"></p>
                    <p id="productPrice"></p>
                </div>
                <div>
                    <form id="orderForm" onsubmit="submitOrder(event)">
                        <div class="form-group">
                            <input type="text" id="customerName" placeholder="Họ tên người nhận" required>
                        </div>
                        <div class="form-group">
                            <input type="tel" id="customerPhone" placeholder="Số điện thoại" required>
                        </div>
                        <div class="form-group">
                            <textarea type="text" id="customerAddress" placeholder="Địa chỉ giao hàng" required></textarea>
                        </div>
                        <div class="form-group">
                            <textarea id="orderNote" placeholder="Ghi chú"></textarea>
                        </div>
                        <button type="submit">Xác nhận đặt hàng</button>
                    </form>
                </div>
            </div>

        </div>
    </div>

    <div id="orderFormModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeOrderFormModal()">&times;</span>
            <h2>Thông tin đơn hàng</h2>
            <form id="orderForm" onsubmit="submitOrder(event)">
                <div class="form-group">
                    <input type="text" id="customerName" placeholder="Họ tên người nhận" required>
                </div>
                <div class="form-group">
                    <input type="tel" id="customerPhone" placeholder="Số điện thoại" required>
                </div>
                <div class="form-group">
                    <textarea type="text" id="customerAddress" placeholder="Địa chỉ giao hàng" required></textarea>
                </div>
                <div class="form-group">
                    <textarea id="orderNote" placeholder="Ghi chú"></textarea>
                </div>
                <button type="submit">Xác nhận đặt hàng</button>
            </form>
        </div>
    </div>

    <div id="orderModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeOrderModal()">&times;</span>
            <h2>Đặt hàng thành công!</h2>
            <p>Cảm ơn bạn đã đặt hàng. Chúng tôi sẽ liên hệ sớm nhất!</p>
        </div>
    </div>

    <script>
        const api = "https://script.google.com/macros/s/AKfycbxvh6gHjehy3q-3QD4g-msL-kZwnYxNU_nlB9hFshzDcO6s9YPnhLHEocZ8S8r86iIEVQ/exec";
        let currentProducts = [];
        let selectedProductRow = null;

        async function loadProducts() {
            try {
                const response = await fetch(api);
                const data = await response.json();
                currentProducts = data;
                displayProducts(data);
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        async function loadOrder() {
            try {
                const response = await fetch(`${api}?action=order`);
                const orders = await response.json();
                console.log(orders)
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        function truncateString(str, maxLength) {
            if (str.length > maxLength) {
                return str.slice(0, maxLength) + '...';
            }
            return str; 
        }        

        function displayProducts(products) {
            const container = document.getElementById('productList');
            container.innerHTML = products.map(product => `
                <div class="product" onclick="openModal('${product.row}')">
                    <div class="image-container">
                        <img src="./img-0541.png" alt="${product['Tên sản phẩm']}">
                    </div>
                    <h3>${truncateString(product['Tên sản phẩm'], 20)}</h3>
                    <p>Giá: ${product['Giá'].toLocaleString()} VND</p>
                </div>
            `).join('');
        }

        function openModal(row) {
            const product = currentProducts.find(p => p.row === parseInt(row));
            if (!product) return;

            selectedProductRow = product.row;
            document.getElementById('productTitle').textContent = product['Tên sản phẩm'];
            document.getElementById('image').setAttribute("src","/img-0541.png");
            document.getElementById('productDescription').textContent = product['Mô tả'];
            document.getElementById('productPrice').textContent = `Giá: ${product['Giá'].toLocaleString()} VND`;
            document.getElementById('productModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('productModal').style.display = 'none';
            selectedProductRow = null;
        }

        

        async function deleteProduct() {
            if (!selectedProductRow) return;
            if (!confirm('Bạn có chắc muốn xóa sản phẩm này?')) return;

            const formData = new FormData();
            formData.append('action', 'delete');
            formData.append('row', selectedProductRow);

            try {
                await fetch(api, {
                    method: 'POST',
                    body: formData
                });
                loadProducts();
                closeModal();
            } catch (error) {
                console.error('Error deleting product:', error);
            }
        }

        function editProduct() {
            const product = currentProducts.find(p => p.row === selectedProductRow);
            if (!product) return;

            document.getElementById('productName').value = product['Tên sản phẩm'];
            document.getElementById('productPrice').value = product['Giá'];
            document.getElementById('productImage').value = product['Ảnh'];
            document.getElementById('productDesc').value = product['Mô tả'];
            closeModal();
        }

        function orderProduct() {
            document.getElementById('productModal').style.display = 'none';
            document.getElementById('orderFormModal').style.display = 'flex';
        }

        function closeOrderFormModal() {
            document.getElementById('productModal').style.display = 'none';
        }

        function closeSuccessModal() {
            document.getElementById('orderSuccessModal').style.display = 'none';
        }

        async function submitOrder(event) {
            event.preventDefault();
            const product = currentProducts.find(p => p.row === selectedProductRow);
            
            const formData = new FormData();
            formData.append('action', 'order');
            formData.append('customerName', document.getElementById('customerName').value);
            formData.append('customerPhone', document.getElementById('customerPhone').value);
            formData.append('customerAddress', document.getElementById('customerAddress').value);
            formData.append('orderNote', document.getElementById('orderNote').value);
            formData.append('productName', product['Tên sản phẩm']);
            formData.append('productPrice', product['Giá']);

            try {
                await fetch(api, {
                    method: 'POST',
                    body: formData
                });
                document.getElementById('orderFormModal').style.display = 'none';
                document.getElementById('orderSuccessModal').style.display = 'flex';
                document.getElementById('orderForm').reset();
            } catch (error) {
                console.error('Error placing order:', error);
                alert('Có lỗi xảy ra khi đặt hàng. Vui lòng thử lại!');
            }
        }

        // Load products on page load
        loadProducts();
        loadOrder()

    </script>
</body>
</html>